## ğŸ“† 2021-02-19(ê¸ˆ) TIL

### ğŸ“ˆ ì–´ì œì˜ ê³„íšì´ ì˜ˆìƒëŒ€ë¡œ ì§„í–‰ëë‚˜ìš”?
- [x] ì•Œê³ ë¦¬ì¦˜ ê³µë¶€
  - section 2ë¥¼ ëëƒˆë‹¤.
- [x] Recoilë¥¼ ì‚¬ìš©í•œ ToDo ì•± ë§Œë“¤ê¸° ì§„í–‰í•˜ê¸° (ë°±ì•¤ë“œ api ë§Œë“¤ê¸°)
  - íšŒì›ì¸ì¦ì‹œ í•„ìš”í•œ JWTë¥¼ ì ìš©í•˜ì˜€ë‹¤. ([PR Link](https://github.com/saseungmin/Recoil_Todo_Backend/pull/7))
- [ ] ì—˜ë ˆê°•íŠ¸ ì˜¤ë¸Œì íŠ¸ ì±… ì½ê¸°

### ğŸ¦„ ì´ë²ˆì£¼ ëª©í‘œ ì§„í–‰ì‚¬í•­ì€ìš”? (ì˜¤ëŠ˜ ì¡°ê¸ˆì´ë¼ë„ ì§„í–‰í–ˆìœ¼ë©´ ì²´í¬)
- [x] ì•Œê³ ë¦¬ì¦˜ ê³µë¶€ ì‹œì‘í•˜ê¸°
- [ ] TypeScript, ì•¨ë ˆê°•íŠ¸ ì˜¤ë¸Œì íŠ¸, Pro Git ì±… ì½ê¸°
- [x] Recoilë¥¼ ì‚¬ìš©í•œ ToDo ì•± ë§Œë“¤ê¸° ì§„í–‰í•˜ê¸° (ë°±ì•¤ë“œ)
- [ ] ê°œì¸ í”„ë¡œì íŠ¸(ìŠ¤í„°ë”” í›„ê¸°)

### ğŸ¤” ê³µë¶€í•˜ë©´ì„œ ë°°ìš´ê²ƒì´ ìˆë‹¤ë©´?

#### ğŸˆ Recoilë¥¼ ì‚¬ìš©í•œ ToDo ì•± ë§Œë“¤ê¸°(ë°±ì•¤ë“œ)
- íšŒì›ì¸ì¦ì— ì‚¬ìš©í•  í† í° ë°©ì‹ì¸ JWTë¥¼ ì ìš©í•˜ì˜€ë‹¤.
- JWTëŠ” ìœ ì €ê°€ ë¡œê·¸ì¸ì„ í•˜ë©´, ì„œë²„ëŠ” ìœ ì €ì˜ ì •ë³´ì— ê¸°ë°˜í•œ í† í°ì„ ë°œê¸‰í•˜ì—¬ ìœ ì €ì—ê²Œ ì „ë‹¬í•´ì£¼ê³  ìœ ì €ê°€ ì„œë²„ì— ìš”ì²­ì„ í•  ë•Œ ë§ˆë‹¤ JWTë¥¼ í¬í•¨í•˜ì—¬ ì „ë‹¬í•œë‹¤.
- JWTëŠ” ì„œë²„ê°€ í´ë¼ì´ì–¸íŠ¸ì—ê²Œì„œ ìš”ì²­ì„ ë°›ì„ë•Œ ë§ˆë‹¤, í•´ë‹¹ í† í°ì´ ìœ íš¨í•˜ê³  ì¸ì¦ëëŠ”ì§€ ê²€ì¦ì„ í•˜ê³ , ìœ ì €ê°€ ìš”ì²­í•œ ì‘ì—…ì— ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸í•˜ì—¬ ì‘ì—…ì„ ì²˜ë¦¬í•œë‹¤.
- ê·¸ë˜ì„œ ì„œë²„ì¸¡ì—ì„œëŠ” ìœ ì €ì˜ ì„¸ì…˜ì„ ìœ ì§€ í•  í•„ìš”ê°€ ì—†ì–´ì§€ê²Œ ëœë‹¤. ì¦‰, ìœ ì €ê°€ ë¡œê·¸ì¸ë˜ì–´ìˆëŠ”ì§€ ì•ˆë˜ì–´ìˆëŠ”ì§€ ì‹ ê²½ ì“¸ í•„ìš”ê°€ ì—†ê³ , ìœ ì €ê°€ ìš”ì²­ì„ í–ˆì„ë•Œ **í† í°ë§Œ í™•ì¸í•˜ë©´** ë˜ì„œ, ì„¸ì…˜ ê´€ë¦¬ê°€ í•„ìš” ì—†ì–´ì„œ ì„œë²„ ìì›ì„ ë§ì´ ì•„ë‚„ ìˆ˜ ìˆê²Œ ëœë‹¤.
- ì´ê±¸ ê°„í¸í•˜ê²Œ ì‚¬ìš©í•˜ê²Œ í•´ì£¼ëŠ” `jsonwebtoken` ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•´ì„œ ê°„ë‹¨í•˜ê²Œ ì ìš©í•  ìˆ˜ ìˆë‹¤.

```
> npm i -S jsonwebtoken
```

- íšŒì›ê°€ì…ì‹œ í† í°ì„ ì œê³µí•´ì¤˜ì•¼í–ë˜ê²Œ ë•Œë¬¸ì— ìŠ¤í‚¤ë§ˆ ë©”ì„œë“œë¥¼ ì •ì˜í•˜ì—¬ í† í° ì„œëª…ì„ ë§Œë“ ë‹¤.

```javascript
UserSchema.methods.generateToken = function () {
  const token = jwt.sign(
    { // ì €ì¥í•˜ê³  ì‹¶ì€ ì •ë³´
      _id: this._id,
      id: this.id,
    },
    process.env.JWT_SECRET, // ë¹„ë°€í‚¤
    {
      expiresIn: '5d', // 5ì¼ ë’¤ ì„¸ì…˜ ë§Œë£Œ
    },
  );

  return token;
};
```
- íšŒì›ê°€ì…ì‹œ í† í°ì„ ë°œê¸‰í•˜ì—¬ ì¿ í‚¤ì— ì €ì¥í•œë‹¤. 

```javascript
const token = user.generateToken();

ctx.cookies.set('access_token', token, { // access_token ì´ë¦„ìœ¼ë¡œ í† í°ì„ ì €ì¥
  maxAge: 1000 * 60 * 60 * 24 * 5, // ì¿ í‚¤ ë§Œë£Œì¼ì€ 5ì¼ ë’¤
  // httpOnlyëŠ” ìë°”ìŠ¤í¬ë¦½íŠ¸ì˜ document.cookieë¥¼ ì´ìš©í•´ì„œ ì¿ í‚¤ì— ì ‘ì†í•˜ëŠ” ê²ƒì„ ë§‰ëŠ” ì˜µì…˜ìœ¼ë¡œ ì¿ í‚¤ë¥¼ í›”ì³ê°€ëŠ” í–‰ìœ„ë¥¼ ë§‰ê¸° ìœ„í•œ ë°©ë²•ì´ë‹¤.
  httpOnly: true,
});
```

- ê·¸ë¦¬ê³  íšŒì›ì¸ì¦ì„ ìœ„í•œ middlewareë¥¼ ë“±ë¡í•´ì¤€ë‹¤.

```javascript
import jwt from 'jsonwebtoken';

import User from '../models/user';

const jwtMiddleware = async (ctx, next) => {
  const token = ctx.cookies.get('access_token'); // access_tokenìœ¼ë¡œ ëœ í† í°ì„ ê°€ì ¸ì˜¨ë‹¤.

  if (!token) { // ì—†ìœ¼ë©´ íŒ¨ìŠ¤
    return next();
  }

  try {
    // í† í°ê³¼ ë¹„ë°€í‚¤ë¥¼ ì‚¬ìš©í•´ ë³µí˜¸í™”í•œë‹¤. 
    const decoded = jwt.verify(token, process.env.JWT_SECRET); 

    ctx.state.user = { // user ì •ë³´ì— ë‹´ëŠ”ë‹¤.
      _id: decoded._id,
      id: decoded.id,
    };

    const now = Math.floor(Date.now() / 1000);

    if (decoded.exp - now < 60 * 60 * 24 * 2) { // ë§Œì•½ ë§Œë£Œì¼ì´ 2ì¼ë³´ë‹¤ ì ê²Œ ë‚¨ì•˜ìœ¼ë©´
      const user = await User.findById(decoded._id); // í•´ë‹¹ objectIdì˜ ìœ ì €ë¥¼ ì°¾ëŠ”ë‹¤.
      const token = user.generateToken(); // í† í°ì„ ì¬ë°œê¸‰í•œë‹¤.

      ctx.cookies.set('access_token', token, { // ë‹¤ì‹œ ì¿ í‚¤ë¥¼ 5ì¼ë¡œ ì„¤ì • í•œë‹¤.
        maxAge: 1000 * 60 * 60 * 24 * 5,
        httpOnly: true,
      });
    }

    return next();
  } catch (error) {
    return next();
  }
};

export default jwtMiddleware;
```

### âš¡ ì•„ì‰¬ìš´ ì  ë° íšŒê³ 
- ì˜¤ëŠ˜ë„ ì—­ì‹œ ì ì´ ì•ˆì™€ì„œ 4ì‹œë°˜ì¯¤ì— ì¤ë‹¤. ê·¸ë˜ì„œ ë˜ 11ì‹œì— ì¼ì–´ë‚¬ë‹¤.
- ì˜¤ëŠ˜ë„ ì—˜ë ˆê°•íŠ¸ ì˜¤ë¸Œì íŠ¸ë¥¼ ì½ì§€ ëª»í–ˆë‹¤. ë‚´ì¼ ê°€ê¸°ì „ì—ë¼ë„ ì¢€ ì½ê³  ê°€ì•¼ê² ë‹¤.
- ë°±ì•¤ë“œë¶€ë¶„ì€ ì†ë‹ê°€ ì˜ ì•ˆë‚œë‹¤. ì²˜ìŒì´ë¼ ì‹œê°„ íˆ¬ìê°€ ë§ì€ ê±° ê°™ë‹¤. ì´ì   ì§„ì§œ í˜ë“  ì‚°ì€ ë‹¤ ë„˜ì—ˆë‹¤ê³  ìƒê°í•œë‹¤.
- ì–¼ë¥¸ recoil_todoë¥¼ ëë‚´ì•¼ê² ë‹¤. ì•„ë§ˆ ë‹¤ìŒì£¼ê¹Œì§€ í•˜ë©´ í•  ìˆ˜ ìˆì§€ ì•Šì„ê¹Œ? ì‹¶ë‹¤.
- ì•Œê³ ë¦¬ì¦˜ ê³µë¶€ë„ ì²˜ìŒì—ëŠ” ë„ˆë¬´ ì‰½ë‹¤ ìƒê°í•´ì„œ ê´œíˆ ë“¤ì—ˆë‚˜? ì‹¶ì—ˆì§€ë§Œ, ê·¸ë˜ë„ ì ì  ì–´ë ¤ì›Œì§€ê³  ìˆì–´ ì¶©ë¶„íˆ ë„ì›€ì´ ë  ë§Œí•œ ê°•ì˜ë¼ê³  ìƒê°í•œë‹¤. ë¬¼ë¡  ê°•ì‚¬ë‹˜ì€ ì½”ë“œëŠ” readabilityì™€ ë³µì¡ì„±, ê²°í•©ë„, immutableë“±ì„ ì „í˜€ ì‹ ê²½ì“°ì§€ ì•Šê³  í’€ì–´ì„œ ì†”ì§íˆ ì˜ì•„í•˜ë‹¤. ë•Œë¬¸ì— ë‚´ê°€ ë¨¼ì € ë¬¸ì œë¥¼ í’€ê³  ëª¨ë¥´ë©´ ê°•ì˜ì—ì„œ íŒíŠ¸ë¥¼ ì–»ê³  ë‚´ ë°©ì‹ëŒ€ë¡œ í’€ê³  ìˆë‹¤.
- ë‚´ì¼ì€ ì•„ë§ˆ ê³µë¶€ë¥¼ í•œìë„ ëª»í•  ë“¯ ì‹¶ë‹¤. ë†€ëŸ¬ê°€ê¸° ë•Œë¬¸ì—.. ê°€ì„œ ì¡°ê¸ˆì´ë¼ë„ í• ê¹Œ? ìƒê°ì€ í–ˆì§€ë§Œ ë§ë„ì•ˆë˜ëŠ” ì†Œë¦¬ë‹¤. ê·¸ë˜ë„ ë‚´ì¼ ë†€ëŸ¬ê°€ì„œ ì‰¬ê³  ì˜¤ë©´ ê¸°ë¶„ì€ ì¢‹ì•„ì§€ê² ì§€!

### ğŸš€ ë‚´ì¼ í•  ì¼
- ë‚´ì¼ì€ ë†€ëŸ¬ê°€ìš”!

### ğŸ¯ ì´ë²ˆì£¼ ëª©í‘œ
- ì•Œê³ ë¦¬ì¦˜ ê³µë¶€ ì‹œì‘í•˜ê¸°
- TypeScript, ì•¨ë ˆê°•íŠ¸ ì˜¤ë¸Œì íŠ¸, Pro Git ì±… ì½ê¸° (ë‹¤ ì½ëŠ”ë‹¤ëŠ” ëœ»ì´ ì•„ë‹˜.)
- Recoilë¥¼ ì‚¬ìš©í•œ ToDo ì•± ë§Œë“¤ê¸° ì§„í–‰í•˜ê¸°
- ê°œì¸ í”„ë¡œì íŠ¸(ìŠ¤í„°ë”” í›„ê¸°)